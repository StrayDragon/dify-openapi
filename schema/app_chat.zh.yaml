openapi: 3.0.0
info:
  title: Dify API - 对话型应用
  description: |
    Dify API 提供了一系列接口用于对话功能。
    支持对话型应用。
    所有 API 请求都需要在 Authorization HTTP Header 中包含应用级 API-Key。
    官方原始文档见: https://github.com/langgenius/dify/blob/1.7.2/web/app/components/develop/template/template_chat.zh.mdx
  version: 1.7.2

servers:
  - url: https://api.dify.ai/v1
    description: Dify API 服务器

  - url: "{api_url}"
    variables:
      api_url:
        default: https://api.dify.ai/v1
        description: 自定义 API 服务器 URL

  - url: http://ai.urchinet.lan/v1
    description: author of dify-openapi dev server

security:
  - bearerApiKeyAuth: []

components:
  securitySchemes:
    bearerApiKeyAuth:
      type: http
      scheme: bearer

  responses:
    Error400:
      description: 请求错误
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    Error401:
      description: 未授权或授权失败
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    Error404:
      description: 资源不存在
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    Error500:
      description: 服务器错误
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

  schemas:
    Error:
      type: object
      properties:
        code:
          type: string
          description: 错误代码
        status:
          type: integer
          description: HTTP 状态码
        message:
          type: string
          description: 错误信息描述
      required:
        - code
        - status
        - message

    Usage:
      type: object
      properties:
        prompt_tokens:
          type: integer
          description: 提示词使用的 token 数量
        completion_tokens:
          type: integer
          description: 补全使用的 token 数量
        total_tokens:
          type: integer
          description: 总共使用的 token 数量
        prompt_unit_price:
          type: string
          description: 提示词单价
        prompt_price_unit:
          type: string
          description: 提示词价格单位
        prompt_price:
          type: string
          description: 提示词总价
        completion_unit_price:
          type: string
          description: 补全单价
        completion_price_unit:
          type: string
          description: 补全价格单位
        completion_price:
          type: string
          description: 补全总价
        total_price:
          type: string
          description: 总价格
        currency:
          type: string
          description: 货币单位
        latency:
          type: number
          description: 延迟时间

    RetrieverResource:
      type: object
      properties:
        position:
          type: integer
          description: 位置
        dataset_id:
          type: string
          description: 数据集ID
        dataset_name:
          type: string
          description: 数据集名称
        document_id:
          type: string
          description: 文档ID
        document_name:
          type: string
          description: 文档名称
        segment_id:
          type: string
          description: 分段ID
        score:
          type: number
          description: 相关度分数
        content:
          type: string
          description: 内容

    ChatCompletionResponse:
      type: object
      properties:
        message_id:
          type: string
          description: 消息唯一 ID
        created_at:
          type: integer
          description: 消息创建时间戳
        metadata:
          type: object
          properties:
            usage:
              $ref: "#/components/schemas/Usage"
            retriever_resources:
              type: array
              items:
                $ref: "#/components/schemas/RetrieverResource"
        conversation_id:
          type: string
          description: 会话ID
        mode:
          type: string
          description: App 模式，固定为 chat
        answer:
          type: string
          description: 完整回复内容

    Conversation:
      type: object
      properties:
        id:
          type: string
          description: 会话 ID
        name:
          type: string
          description: 会话名称
        inputs:
          type: object
          description: 用户输入参数
        status:
          type: string
          description: 会话状态
        introduction:
          type: string
          description: 开场白
        created_at:
          type: integer
          description: 创建时间
        updated_at:
          type: integer
          description: 更新时间

    FileInput:
      type: object
      properties:
        type:
          type: string
          enum: [document, image, audio, video, custom]
          description: 文件类型
        transfer_method:
          type: string
          enum: [remote_url, local_file]
          description: 传递方式
        url:
          type: string
          description: 远程URL
        upload_file_id:
          type: string
          description: 上传文件ID

    ChatHistoryMessage:
      type: object
      properties:
        id:
          type: string
          description: 消息 ID
        conversation_id:
          type: string
          description: 会话 ID
        inputs:
          type: object
          description: 用户输入参数
        query:
          type: string
          description: 用户输入/提问内容
        message_files:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                description: ID
              type:
                type: string
                description: 文件类型，image 图片
              url:
                type: string
                description: 预览图片地址
              belongs_to:
                type: string
                description: 文件归属方，user 或 assistant
          description: 消息文件
        agent_thoughts:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                description: agent_thought ID，每一轮Agent迭代都会有一个唯一的id
              message_id:
                type: string
                description: 消息唯一ID
              position:
                type: integer
                description: agent_thought在消息中的位置，如第一轮迭代position为1
              thought:
                type: string
                description: agent的思考内容
              observation:
                type: string
                description: 工具调用的返回结果
              tool:
                type: string
                description: 使用的工具列表，以 ; 分割多个工具
              tool_input:
                type: string
                description: '工具的输入，JSON格式的字符串(object)。如：{"dalle3": {"prompt": "a cute cat"}}'
              created_at:
                type: integer
                description: 创建时间戳，如：1705395332
              message_files:
                type: array
                items:
                  type: string
                description: 当前agent_thought关联的文件ID
              conversation_id:
                type: string
                description: 会话ID
          description: Agent思考内容（仅Agent模式下不为空）
        answer:
          type: string
          description: 回答消息内容
        created_at:
          type: integer
          description: 创建时间
        feedback:
          type: object
          properties:
            rating:
              type: string
              enum: [like, dislike]
              description: 点赞 like / 点踩 dislike
          description: 反馈信息
        retriever_resources:
          type: array
          items:
            $ref: "#/components/schemas/RetrieverResource"
          description: 引用和归属分段列表

    ChunkChatCompletionResponse:
      type: object
      properties:
        event:
          type: string
          enum:
            [
              message,
              message_end,
              tts_message,
              tts_message_end,
              message_replace,
              error,
              ping,
              agent_message,
              agent_thought,
              message_file,
            ]
          description: 事件类型
        task_id:
          type: string
          description: 任务 ID，用于请求跟踪和停止响应接口
        message_id:
          type: string
          description: 消息唯一 ID
        conversation_id:
          type: string
          description: 会话 ID
        workflow_run_id:
          type: string
          description: workflow 执行 ID
        answer:
          type: string
          description: 回复内容
        audio:
          type: string
          description: 语音合成音频数据（base64编码）
        data:
          type: object
          description: 事件相关数据
        metadata:
          type: object
          description: 元数据信息，包含使用量和检索资源
          properties:
            usage:
              $ref: "#/components/schemas/Usage"
            retriever_resources:
              type: array
              items:
                $ref: "#/components/schemas/RetrieverResource"
        created_at:
          type: integer
          description: 创建时间戳
        id:
          type: string
          description: 唯一ID
        position:
          type: integer
          description: agent_thought在消息中的位置，如第一轮迭代position为1
        thought:
          type: string
          description: agent的思考内容
        observation:
          type: string
          description: 工具调用的返回结果
        tool:
          type: string
          description: 使用的工具列表，以 ; 分割多个工具
        tool_input:
          type: string
          description: 工具的输入，JSON格式的字符串
        message_files:
          type: array
          items:
            type: string
          description: 当前agent_thought关联的文件ID
        type:
          type: string
          description: 文件类型
        belongs_to:
          type: string
          description: 文件归属，user或assistant
        url:
          type: string
          description: 文件访问地址

    UploadedFile:
      type: object
      properties:
        id:
          type: string
          description: 文件 ID
        name:
          type: string
          description: 文件名
        size:
          type: integer
          description: 文件大小（byte）
        extension:
          type: string
          description: 文件后缀
        mime_type:
          type: string
          description: 文件 mime-type
        created_by:
          type: string
          description: 上传人 ID
        created_at:
          type: integer
          description: 上传时间

paths:
  /chat-messages:
    post:
      operationId: sendChatMessageByAppChat
      summary: 发送对话消息(对话型应用)
      description: 创建会话消息
      x-fern-streaming:
        format: sse
        # FIXME: @l8ng fern 暂时不支持
        # stream-condition: $request.response_mode == "streaming"
        response:
          $ref: "#/components/schemas/ChatCompletionResponse"
        response-stream:
          $ref: "#/components/schemas/ChunkChatCompletionResponse"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - query
              properties:
                query:
                  type: string
                  description: 用户输入/提问内容
                inputs:
                  type: object
                  description: 允许传入 App 定义的各变量值。inputs 参数包含了多组键值对（Key/Value pairs），每组的键对应一个特定变量，每组的值则是该变量的具体值。默认 {}
                response_mode:
                  type: string
                  enum: [streaming, blocking]
                  description: |
                    响应模式:
                    - streaming: 流式模式（推荐），基于 SSE 实现类似打字机输出
                    - blocking: 阻塞模式，等待执行完毕后返回结果（请求若流程较长可能会被中断）
                    注：Agent模式下不允许blocking
                user:
                  type: string
                  description: 用户标识，用于定义终端用户的身份，方便检索、统计。由开发者定义规则，需保证用户标识在应用内唯一。服务 API 不会共享 WebApp 创建的对话。
                conversation_id:
                  type: string
                  description: （选填）会话 ID，需要基于之前的聊天记录继续对话，必须传之前消息的 conversation_id
                files:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                        enum: [image]
                        description: 支持类型：图片 image（目前仅支持图片格式）
                      transfer_method:
                        type: string
                        enum: [remote_url, local_file]
                        description: 传递方式
                      url:
                        type: string
                        description: 图片地址（仅当传递方式为 remote_url 时）
                      upload_file_id:
                        type: string
                        description: 上传文件 ID（仅当传递方式为 local_file 时）
                  description: 上传的文件
                auto_generate_name:
                  type: boolean
                  description: （选填）自动生成标题，默认 true。若设置为 false，则可通过调用会话重命名接口并设置 auto_generate 为 true 实现异步生成标题。
                  default: true
                workflow_id:
                  type: string
                  description: （选填）工作流ID，用于指定特定版本，如果不提供则使用默认的已发布版本。
                trace_id:
                  type: string
                  description: |
                    （选填）链路追踪ID。适用于与业务系统已有的trace组件打通，实现端到端分布式追踪等场景。如果未指定，系统会自动生成trace_id。支持以下三种方式传递，具体优先级依次为：
                    - Header：通过 HTTP Header X-Trace-Id 传递，优先级最高。
                    - Query 参数：通过 URL 查询参数 trace_id 传递。
                    - Request Body：通过请求体字段 trace_id 传递（即本字段）。
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatCompletionResponse"
                description: 当 response_mode 为 blocking 时，返回 ChatCompletionResponse object
            text/event-stream:
              schema:
                $ref: "#/components/schemas/ChunkChatCompletionResponse"
                format: sse
                description: |
                  当 response_mode 为 streaming时，返回 ChunkChatCompletionResponse object 流式序列。
                  返回 App 输出的流式块，Content-Type 为 text/event-stream。
                  每个流式块均为 data: 开头，块之间以 \n\n 即两个换行符分隔，如下所示：

                  data: {"event": "message", "task_id": "900bbd43-dc0b-4383-a372-aa6e6c414227", "id": "663c5084-a254-4040-8ad3-51f2a3c1a77c", "answer": "Hi", "created_at": 1705398420}\n\n

                  流式块中根据 event 不同，结构也不同：

                  - event: message LLM 返回文本块事件，即：完整的文本以分块的方式输出。
                    - task_id (string) 任务 ID，用于请求跟踪和下方的停止响应接口
                    - message_id (string) 消息唯一 ID
                    - conversation_id (string) 会话 ID
                    - answer (string) LLM 返回文本块内容
                    - created_at (int) 创建时间戳，如：1705395332
                  - event: message_file 文件事件，表示有新文件需要展示
                    - id (string) 文件唯一ID
                    - type (string) 文件类型，目前仅为image
                    - belongs_to (string) 文件归属，user或assistant，该接口返回仅为 assistant
                    - url (string) 文件访问地址
                    - conversation_id (string) 会话ID
                  - event: message_end 消息结束事件，收到此事件则代表流式返回结束。
                    - task_id (string) 任务 ID，用于请求跟踪和下方的停止响应接口
                    - message_id (string) 消息唯一 ID
                    - conversation_id (string) 会话 ID
                    - metadata (object) 元数据
                      - usage (Usage) 模型用量信息
                      - retriever_resources (array[RetrieverResource]) 引用和归属分段列表
                  - event: tts_message TTS 音频流事件，即：语音合成输出。内容是Mp3格式的音频块，使用 base64 编码后的字符串，播放的时候直接解码即可。(开启自动播放才有此消息)
                    - task_id (string) 任务 ID，用于请求跟踪和下方的停止响应接口
                    - message_id (string) 消息唯一 ID
                    - audio (string) 语音合成之后的音频块使用 Base64 编码之后的文本内容，播放的时候直接 base64 解码送入播放器即可
                    - created_at (int) 创建时间戳，如：1705395332
                  - event: tts_message_end TTS 音频流结束事件，收到这个事件表示音频流返回结束。
                    - task_id (string) 任务 ID，用于请求跟踪和下方的停止响应接口
                    - message_id (string) 消息唯一 ID
                    - audio (string) 结束事件是没有音频的，所以这里是空字符串
                    - created_at (int) 创建时间戳，如：1705395332
                  - event: message_replace 消息内容替换事件。 开启内容审查和审查输出内容时，若命中了审查条件，则会通过此事件替换消息内容为预设回复。
                    - task_id (string) 任务 ID，用于请求跟踪和下方的停止响应接口
                    - message_id (string) 消息唯一 ID
                    - conversation_id (string) 会话 ID
                    - answer (string) 替换内容（直接替换 LLM 所有回复文本）
                    - created_at (int) 创建时间戳，如：1705395332
                  - event: workflow_started workflow 开始执行
                    - task_id (string) 任务 ID，用于请求跟踪和下方的停止响应接口
                    - workflow_run_id (string) workflow 执行 ID
                    - event (string) 固定为 workflow_started
                    - data (object) 详细内容
                      - id (string) workflow 执行 ID
                      - workflow_id (string) 关联 Workflow ID
                      - created_at (timestamp) 开始时间
                  - event: node_started node 开始执行
                    - task_id (string) 任务 ID，用于请求跟踪和下方的停止响应接口
                    - workflow_run_id (string) workflow 执行 ID
                    - event (string) 固定为 node_started
                    - data (object) 详细内容
                      - id (string) workflow 执行 ID
                      - node_id (string) 节点 ID
                      - node_type (string) 节点类型
                      - title (string) 节点名称
                      - index (int) 执行序号，用于展示 Tracing Node 顺序
                      - predecessor_node_id (string) 前置节点 ID，用于画布展示执行路径
                      - inputs (object) 节点中所有使用到的前置节点变量内容
                      - created_at (timestamp) 开始时间
                  - event: node_finished node 执行结束，成功失败同一事件中不同状态
                    - task_id (string) 任务 ID，用于请求跟踪和下方的停止响应接口
                    - workflow_run_id (string) workflow 执行 ID
                    - event (string) 固定为 node_finished
                    - data (object) 详细内容
                      - id (string) node 执行 ID
                      - node_id (string) 节点 ID
                      - index (int) 执行序号，用于展示 Tracing Node 顺序
                      - predecessor_node_id (string) optional 前置节点 ID，用于画布展示执行路径
                      - inputs (object) 节点中所有使用到的前置节点变量内容
                      - process_data (json) Optional 节点过程数据
                      - outputs (json) Optional 输出内容
                      - status (string) 执行状态 running / succeeded / failed / stopped
                      - error (string) Optional 错误原因
                      - elapsed_time (float) Optional 耗时(s)
                      - execution_metadata (json) 元数据
                        - total_tokens (int) optional 总使用 tokens
                        - total_price (decimal) optional 总费用
                        - currency (string) optional 货币，如 USD / RMB
                      - created_at (timestamp) 开始时间
                  - event: workflow_finished workflow 执行结束，成功失败同一事件中不同状态
                    - task_id (string) 任务 ID，用于请求跟踪和下方的停止响应接口
                    - workflow_run_id (string) workflow 执行 ID
                    - event (string) 固定为 workflow_finished
                    - data (object) 详细内容
                      - id (string) workflow 执行 ID
                      - workflow_id (string) 关联 Workflow ID
                      - status (string) 执行状态 running / succeeded / failed / stopped
                      - outputs (json) Optional 输出内容
                      - error (string) Optional 错误原因
                      - elapsed_time (float) Optional 耗时(s)
                      - total_tokens (int) Optional 总使用 tokens
                      - total_steps (int) 总步数（冗余），默认 0
                      - created_at (timestamp) 开始时间
                      - finished_at (timestamp) 结束时间
                  - event: error 流式输出过程中出现的异常会以 stream event 形式输出，收到异常事件后即结束。
                    - task_id (string) 任务 ID，用于请求跟踪和下方的停止响应接口
                    - message_id (string) 消息唯一 ID
                    - status (int) HTTP 状态码
                    - code (string) 错误码
                    - message (string) 错误消息
                  - event: ping 每 10s 一次的 ping 事件，保持连接存活。
        "400":
          description: 请求错误
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Error"
                  - type: object
                    properties:
                      code:
                        enum: [invalid_param, app_unavailable, provider_not_initialize, provider_quota_exceeded, model_currently_not_support, workflow_not_found, draft_workflow_error, workflow_id_format_error, completion_request_error]
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"

  /files/{file_id}/preview:
    get:
      operationId: previewFileByAppChat
      summary: 文件预览
      description: |
        预览或下载已上传的文件。此端点允许您访问先前通过文件上传 API 上传的文件。
        文件只能在属于请求应用程序的消息范围内访问。
      parameters:
        - name: file_id
          in: path
          required: true
          schema:
            type: string
          description: 要预览的文件的唯一标识符，从文件上传 API 响应中获得
        - name: as_attachment
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: 是否强制将文件作为附件下载。默认为 false（在浏览器中预览）
      responses:
        "200":
          description: 文件内容
          content:
            '*/*':
              schema:
                type: string
                format: binary
          headers:
            Content-Type:
              description: 根据文件 MIME 类型设置
              schema:
                type: string
            Content-Length:
              description: 文件大小（以字节为单位，如果可用）
              schema:
                type: integer
            Content-Disposition:
              description: 如果 as_attachment=true 则设置为 "attachment"
              schema:
                type: string
            Cache-Control:
              description: 用于性能的缓存标头
              schema:
                type: string
            Accept-Ranges:
              description: 对于音频/视频文件设置为 "bytes"
              schema:
                type: string
        "400":
          description: 参数输入异常
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Error"
                  - type: object
                    properties:
                      code:
                        enum: [invalid_param]
        "403":
          description: 文件访问被拒绝或文件不属于当前应用程序
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Error"
                  - type: object
                    properties:
                      code:
                        enum: [file_access_denied]
        "404":
          description: 文件未找到或已被删除
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Error"
                  - type: object
                    properties:
                      code:
                        enum: [file_not_found]
        "500":
          $ref: "#/components/responses/Error500"

  /conversations:
    get:
      operationId: getConversationListByAppChat
      summary: 获取会话列表
      description: 获取当前用户的会话列表
      parameters:
        - name: user
          in: query
          required: true
          schema:
            type: string
        - name: last_id
          in: query
          schema:
            type: string
          description: 当前页最后一条记录的ID
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
          description: 每页记录数
        - name: sort_by
          in: query
          schema:
            type: string
            enum: [created_at, -created_at, updated_at, -updated_at]
            default: -updated_at
          description: 排序字段
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Conversation"
                  has_more:
                    type: boolean
                  limit:
                    type: integer

  /conversations/{conversation_id}:
    delete:
      operationId: deleteConversationByAppChat
      summary: 删除会话
      parameters:
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
          description: 会话ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user
              properties:
                user:
                  type: string
                  description: 用户标识
      responses:
        "204":
          description: 成功响应，无内容

  /conversations/{conversation_id}/name:
    post:
      operationId: renameConversationByAppChat
      summary: 会话重命名
      parameters:
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user
              properties:
                name:
                  type: string
                  description: 新名称
                auto_generate:
                  type: boolean
                  default: false
                  description: 是否自动生成
                user:
                  type: string
                  description: 用户标识
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Conversation"

  /conversations/{conversation_id}/variables:
    get:
      operationId: getConversationVariablesByAppChat
      summary: 获取对话变量
      description: 从特定对话中检索变量。此端点对于提取对话过程中捕获的结构化数据非常有用。
      parameters:
        - name: conversation_id
          in: path
          description: 要从中检索变量的对话ID
          required: true
          schema:
            type: string
        - name: user
          in: query
          description: 用户标识符，由开发人员定义的规则，在应用程序内必须唯一
          required: true
          schema:
            type: string
        - name: last_id
          in: query
          description: （选填）当前页最后面一条记录的 ID，默认 null
          schema:
            type: string
        - name: limit
          in: query
          description: （选填）一次请求返回多少条记录，默认 20 条，最大 100 条，最小 1 条
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  limit:
                    type: integer
                    description: 每页项目数
                  has_more:
                    type: boolean
                    description: 是否有更多项目
                  data:
                    type: array
                    description: 变量列表
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          description: 变量ID
                        name:
                          type: string
                          description: 变量名称
                        value_type:
                          type: string
                          description: 变量类型（字符串、数字、布尔等）
                        value:
                          type: string
                          description: 变量值
                        description:
                          type: string
                          description: 变量描述
                        created_at:
                          type: integer
                          description: 创建时间戳
                        updated_at:
                          type: integer
                          description: 最后更新时间戳
        "404":
          description: 对话不存在
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: string
                    enum: [conversation_not_exists]
                    description: 错误代码
                  message:
                    type: string
                    description: 错误消息

  /conversations/{conversation_id}/variables/{variable_id}:
    put:
      operationId: updateConversationVariableByAppChat
      summary: 更新对话变量
      description: 更新特定对话变量的值。此端点允许您修改在对话过程中捕获的变量值，同时保留其名称、类型和描述。
      parameters:
        - name: conversation_id
          in: path
          description: 包含要更新变量的对话ID
          required: true
          schema:
            type: string
        - name: variable_id
          in: path
          description: 要更新的变量ID
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user
                - value
              properties:
                value:
                  description: 变量的新值。必须匹配变量的预期类型（字符串、数字、对象等）。
                user:
                  type: string
                  description: 用户标识符，由开发人员定义的规则，在应用程序内必须唯一。
      responses:
        "200":
          description: 成功更新变量
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    description: 变量ID
                  name:
                    type: string
                    description: 变量名称
                  value_type:
                    type: string
                    description: 变量类型（字符串、数字、对象等）
                  value:
                    description: 更新后的变量值
                  description:
                    type: string
                    description: 变量描述
                  created_at:
                    type: integer
                    description: 创建时间戳
                  updated_at:
                    type: integer
                    description: 最后更新时间戳
        "400":
          description: 值类型与变量的预期类型不匹配
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Error"
                  - type: object
                    properties:
                      message:
                        example: "Type mismatch: variable expects string, but got number type"
        "404":
          description: 对话不存在或变量不存在
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Error"
                  - type: object
                    properties:
                      code:
                        enum: [conversation_not_exists, conversation_variable_not_exists]

  /messages:
    get:
      operationId: getConversationMessagesByAppChat
      summary: 获取会话历史消息
      parameters:
        - name: conversation_id
          in: query
          required: true
          schema:
            type: string
        - name: user
          in: query
          required: true
          schema:
            type: string
        - name: first_id
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/ChatHistoryMessage"
                  has_more:
                    type: boolean
                  limit:
                    type: integer

  /messages/{message_id}/feedbacks:
    post:
      operationId: sendMessageFeedbackByAppChat
      summary: 消息反馈（点赞）
      description: 消息终端用户反馈、点赞，方便应用开发者优化输出预期
      parameters:
        - name: message_id
          in: path
          required: true
          schema:
            type: string
          description: 消息 ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user
              properties:
                rating:
                  type: string
                  enum: [like, dislike, null]
                  description: 点赞 like, 点踩 dislike, 撤销点赞 null
                user:
                  type: string
                  description: 用户标识，由开发者定义规则，需保证用户标识在应用内唯一。服务 API 不会共享 WebApp 创建的对话。
                content:
                  type: string
                  description: 消息反馈的具体信息
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: string
                    enum: [success]
                    description: 固定返回 success

  /app/feedbacks:
    get:
      operationId: getAppFeedbacksByAppChat
      summary: 获取APP的消息点赞和反馈
      description: 获取应用的终端用户反馈、点赞
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          description: 分页，默认值：1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
          description: 每页数量，默认值：20
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          description: 反馈ID
                        app_id:
                          type: string
                          description: 应用ID
                        conversation_id:
                          type: string
                          description: 会话ID
                        message_id:
                          type: string
                          description: 消息ID
                        rating:
                          type: string
                          description: 评分
                        content:
                          type: string
                          description: 反馈内容
                        from_source:
                          type: string
                          description: 来源
                        from_end_user_id:
                          type: string
                          description: 终端用户ID
                        from_account_id:
                          type: string
                          description: 账户ID
                        created_at:
                          type: string
                          description: 创建时间
                        updated_at:
                          type: string
                          description: 更新时间
                    description: 返回该APP的点赞、反馈列表

  /messages/{message_id}/suggested:
    get:
      operationId: getSuggestedQuestionsByAppChat
      summary: 获取下一轮建议问题列表
      description: 获取下一轮建议问题列表
      parameters:
        - name: message_id
          in: path
          required: true
          schema:
            type: string
          description: Message ID
        - name: user
          in: query
          required: true
          schema:
            type: string
          description: 用户标识，由开发者定义规则，需保证用户标识在应用内唯一。服务 API 不会共享 WebApp 创建的对话。
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: string
                    enum: [success]
                  data:
                    type: array
                    items:
                      type: string
                    description: 建议问题列表

  /files/upload:
    post:
      operationId: uploadFileByAppChat
      summary: 上传文件
      description: |
        上传文件并在发送消息时使用。
        支持的文件类型取决于应用类型和配置。
        上传的文件仅供当前终端用户使用。
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: 要上传的文件
                user:
                  type: string
                  description: 用户标识
              required:
                - file
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadedFile"
        "400":
          $ref: "#/components/responses/Error400"
        "413":
          description: 文件太大
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "415":
          description: 不支持的文件类型
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "503":
          description: 存储服务错误
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /info:
    get:
      operationId: getApplicationInfoByAppChat
      summary: 获取应用基本信息
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                    description: 应用名称
                  description:
                    type: string
                    description: 应用描述
                  tags:
                    type: array
                    items:
                      type: string
                    description: 应用标签
                  mode:
                    type: string
                    description: 应用模式
                  author_name:
                    type: string
                    description: 作者名称

  /chat-messages/{task_id}/stop:
    post:
      operationId: stopChatResponseByAppChat
      summary: 停止响应
      description: 仅支持流式模式
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
          description: 任务 ID，可在流式返回 Chunk 中获取
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user
              properties:
                user:
                  type: string
                  description: 用户标识，用于定义终端用户的身份，必须和发送消息接口传入 user 保持一致。API 无法访问 WebApp 创建的会话。
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: string
                    enum: [success]
                    description: 固定返回 success

  /audio-to-text:
    post:
      operationId: convertAudioToTextByAppChat
      summary: 语音转文字
      description: 语音转文字
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: 语音文件
                user:
                  type: string
                  description: 用户标识
              required:
                - file
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  text:
                    type: string
                    description: 转换后的文本

  /text-to-audio:
    post:
      operationId: convertTextToAudioByAppChat
      summary: 文字转语音
      description: 文字转语音
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                message_id:
                  type: string
                  description: Dify 生成的文本消息ID，后台会通过 message_id 查找相应的内容直接合成语音信息。如果同时传 message_id 和 text，优先使用 message_id
                text:
                  type: string
                  description: 语音生成内容。如果没有传 message_id 的话，则会使用这个字段的内容
                user:
                  type: string
                  description: 用户标识，由开发者定义规则，需保证用户标识在应用内唯一。服务 API 不会共享 WebApp 创建的对话。
      responses:
        "200":
          description: 成功响应
          content:
            audio/wav:
              schema:
                type: string
                format: binary
                description: 音频文件

  /parameters:
    get:
      operationId: getApplicationParametersByAppChat
      summary: 获取应用参数
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  opening_statement:
                    type: string
                    description: 开场白
                  suggested_questions:
                    type: array
                    items:
                      type: string
                    description: 开场推荐问题列表
                  suggested_questions_after_answer:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                    description: 回答后推荐问题设置
                  speech_to_text:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                    description: 语音转文本设置
                  text_to_speech:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        description: 是否开启
                      voice:
                        type: string
                        description: 语音类型
                      language:
                        type: string
                        description: 语言
                      autoPlay:
                        type: string
                        enum: [enabled, disabled]
                        description: 自动播放
                    description: 文本转语音设置
                  retriever_resource:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                    description: 引用和归属设置
                  annotation_reply:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                    description: 标记回复设置
                  user_input_form:
                    type: array
                    items:
                      type: object
                    description: 用户输入表单配置
                  file_upload:
                    type: object
                    description: 文件上传配置
                    properties:
                      document:
                        type: object
                        description: 文档设置。当前仅支持文档类型：txt, md, markdown, pdf, html, xlsx, xls, docx, csv, eml, msg, pptx, ppt, xml, epub。
                        properties:
                          enabled:
                            type: boolean
                            description: 是否启用
                          number_limits:
                            type: integer
                            description: 文档数量限制，默认为 3
                            default: 3
                          transfer_methods:
                            type: array
                            items:
                              type: string
                              enum: [remote_url, local_file]
                            description: 传输方式列表：remote_url, local_file，必须选择一个。
                      image:
                        type: object
                        description: 图片设置。当前仅支持图片类型：png, jpg, jpeg, webp, gif。
                        properties:
                          enabled:
                            type: boolean
                            description: 是否启用
                          number_limits:
                            type: integer
                            description: 图片数量限制，默认为 3
                            default: 3
                          transfer_methods:
                            type: array
                            items:
                              type: string
                              enum: [remote_url, local_file]
                            description: 传输方式列表：remote_url, local_file，必须选择一个。
                      audio:
                        type: object
                        description: 音频设置。当前仅支持音频类型：mp3, m4a, wav, webm, amr。
                        properties:
                          enabled:
                            type: boolean
                            description: 是否启用
                          number_limits:
                            type: integer
                            description: 音频数量限制，默认为 3
                            default: 3
                          transfer_methods:
                            type: array
                            items:
                              type: string
                              enum: [remote_url, local_file]
                            description: 传输方式列表：remote_url, local_file，必须选择一个。
                      video:
                        type: object
                        description: 视频设置。当前仅支持视频类型：mp4, mov, mpeg, mpga。
                        properties:
                          enabled:
                            type: boolean
                            description: 是否启用
                          number_limits:
                            type: integer
                            description: 视频数量限制，默认为 3
                            default: 3
                          transfer_methods:
                            type: array
                            items:
                              type: string
                              enum: [remote_url, local_file]
                            description: 传输方式列表：remote_url, local_file，必须选择一个。
                      custom:
                        type: object
                        description: 自定义设置
                        properties:
                          enabled:
                            type: boolean
                            description: 是否启用
                          number_limits:
                            type: integer
                            description: 自定义数量限制，默认为 3
                            default: 3
                          transfer_methods:
                            type: array
                            items:
                              type: string
                              enum: [remote_url, local_file]
                            description: 传输方式列表：remote_url, local_file，必须选择一个。
                  system_parameters:
                    type: object
                    properties:
                      file_size_limit:
                        type: integer
                        description: 文档上传大小限制 (MB)
                      image_file_size_limit:
                        type: integer
                        description: 图片文件上传大小限制（MB）
                      audio_file_size_limit:
                        type: integer
                        description: 音频文件上传大小限制 (MB)
                      video_file_size_limit:
                        type: integer
                        description: 视频文件上传大小限制 (MB)
                    description: 系统参数

  /meta:
    get:
      operationId: getAppMetaInfoByAppChat
      summary: 获取应用Meta信息
      description: 用于获取工具icon
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  tool_icons:
                    type: object
                    description: 工具图标
                    additionalProperties:
                      oneOf:
                        - type: object
                          properties:
                            background:
                              type: string
                              description: hex 格式的背景色
                            content:
                              type: string
                              description: emoji
                        - type: string
                          description: 图标 URL

  /site:
    get:
      operationId: getAppSiteSettingsByAppChat
      summary: 获取应用 WebApp 设置
      description: 用于获取应用的 WebApp 设置
      responses:
        "200":
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  title:
                    type: string
                    description: WebApp 名称
                  chat_color_theme:
                    type: string
                    description: 聊天颜色主题，hex 格式
                  chat_color_theme_inverted:
                    type: boolean
                    description: 聊天颜色主题是否反转
                  icon_type:
                    type: string
                    description: 图标类型，emoji-表情，image-图片
                  icon:
                    type: string
                    description: 图标，如果是 emoji 类型，则是 emoji 表情符号，如果是 image 类型，则是图片 URL
                  icon_background:
                    type: string
                    description: hex 格式的背景色
                  icon_url:
                    type: string
                    description: 图标 URL
                  description:
                    type: string
                    description: 描述
                  copyright:
                    type: string
                    description: 版权信息
                  privacy_policy:
                    type: string
                    description: 隐私政策链接
                  custom_disclaimer:
                    type: string
                    description: 自定义免责声明
                  default_language:
                    type: string
                    description: 默认语言
                  show_workflow_steps:
                    type: boolean
                    description: 是否显示工作流详情
                  use_icon_as_answer_icon:
                    type: boolean
                    description: 是否使用 WebApp 图标替换聊天中的 🤖

  /apps/annotations:
    get:
      operationId: getAnnotationsListByAppChat
      summary: 获取标注列表
      description: 获取应用的标注列表
      parameters:
        - name: page
          in: query
          description: 页码
          required: false
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: 每页数量
          required: false
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: 成功获取标注列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          description: 标注ID
                        question:
                          type: string
                          description: 问题
                        answer:
                          type: string
                          description: 答案
                        hit_count:
                          type: integer
                          description: 命中次数
                        created_at:
                          type: integer
                          description: 创建时间戳
                  has_more:
                    type: boolean
                    description: 是否有更多数据
                  limit:
                    type: integer
                    description: 每页数量
                  total:
                    type: integer
                    description: 总记录数
                  page:
                    type: integer
                    description: 当前页码

    post:
      operationId: createAnnotationByAppChat
      summary: 创建标注
      description: 创建新的标注
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - question
                - answer
              properties:
                question:
                  type: string
                  description: 问题
                answer:
                  type: string
                  description: 答案
      responses:
        "200":
          description: 成功创建标注
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    description: 标注ID
                  question:
                    type: string
                    description: 问题
                  answer:
                    type: string
                    description: 答案
                  hit_count:
                    type: integer
                    description: 命中次数
                  created_at:
                    type: integer
                    description: 创建时间戳

  /apps/annotations/{annotation_id}:
    put:
      operationId: updateAnnotationByAppChat
      summary: 更新标注
      description: 更新指定的标注
      parameters:
        - name: annotation_id
          in: path
          description: 标注ID
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - question
                - answer
              properties:
                question:
                  type: string
                  description: 问题
                answer:
                  type: string
                  description: 答案
      responses:
        "200":
          description: 成功更新标注
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    description: 标注ID
                  question:
                    type: string
                    description: 问题
                  answer:
                    type: string
                    description: 答案
                  hit_count:
                    type: integer
                    description: 命中次数
                  created_at:
                    type: integer
                    description: 创建时间戳

    delete:
      operationId: deleteAnnotationByAppChat
      summary: 删除标注
      description: 删除指定的标注
      parameters:
        - name: annotation_id
          in: path
          description: 标注ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 成功删除标注
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: string
                    enum: [success]

  /apps/annotation-reply/{action}:
    post:
      operationId: configureAnnotationReplyByAppChat
      summary: 标注回复初始设置
      description: 启用或禁用标注回复功能
      parameters:
        - name: action
          in: path
          description: 动作，只能是 'enable' 或 'disable'
          required: true
          schema:
            type: string
            enum: [enable, disable]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                embedding_provider_name:
                  type: string
                  description: 指定的嵌入模型提供商, 必须先在系统内设定好接入的模型，对应的是provider字段
                embedding_model_name:
                  type: string
                  description: 指定的嵌入模型，对应的是model字段
                score_threshold:
                  type: number
                  description: 相似度阈值，当相似度大于该阈值时，系统会自动回复，否则不回复
      responses:
        "200":
          description: 成功启用或禁用标注回复
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                    description: 任务ID
                  job_status:
                    type: string
                    description: 任务状态

  /apps/annotation-reply/{action}/status/{job_id}:
    get:
      operationId: getAnnotationReplyStatusByAppChat
      summary: 查询标注回复初始设置任务状态
      description: 查询标注回复初始设置任务的执行状态
      parameters:
        - name: action
          in: path
          description: 动作，只能是 'enable' 或 'disable'，并且必须和标注回复初始设置接口的动作一致
          required: true
          schema:
            type: string
            enum: [enable, disable]
        - name: job_id
          in: path
          description: 任务ID，从标注回复初始设置接口返回的job_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 成功获取任务状态
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                    description: 任务ID
                  job_status:
                    type: string
                    description: 任务状态
                  error_msg:
                    type: string
                    description: 错误信息
